# MD Viewer v1.2 开发计划

> **目标**：右键上下文菜单 + 测试覆盖率提升 + 虚拟滚动
> **预计功能点**：15+ 个
> **状态**：✅ 需求已确认，待开发

---

## 〇、需求确认（已完成）

| 问题 | 决策 |
|------|------|
| 复制/剪切范围 | ✅ **应用内 + 跨应用**（写入系统剪贴板） |
| 文件夹支持 | ✅ **支持**（右键菜单适用于文件和文件夹） |
| 删除确认 | ✅ **静默移到回收站**（无二次确认） |
| 快捷键支持 | ✅ **支持** |

---

## 一、功能清单

### 1. 右键上下文菜单（核心功能）

#### 1.1 菜单项清单

| 菜单项 | 适用对象 | 说明 | 快捷键 (macOS / Win) |
|--------|----------|------|---------------------|
| 在 Finder 中显示 | 文件/文件夹 | 打开系统文件管理器并定位 | - |
| 复制路径 | 文件/文件夹 | 复制绝对路径到剪贴板 | ⌘+⌥+C / Ctrl+Alt+C |
| 复制相对路径 | 文件/文件夹 | 复制相对于根目录的路径 | ⇧+⌥+C / Shift+Alt+C |
| 复制 | 文件/文件夹 | 复制到系统剪贴板 | ⌘+C / Ctrl+C |
| 剪切 | 文件/文件夹 | 剪切到系统剪贴板 | ⌘+X / Ctrl+X |
| 粘贴 | 文件夹 | 从剪贴板粘贴文件 | ⌘+V / Ctrl+V |
| 重命名 | 文件/文件夹 | 内联编辑名称 | Enter / F2 |
| 删除 | 文件/文件夹 | 静默移到回收站 | ⌘+⌫ / Delete |

#### 1.2 跨平台适配

| 元素 | macOS | Windows | Linux |
|------|-------|---------|-------|
| 菜单名称 | "在 Finder 中显示" | "在资源管理器中显示" | "在文件管理器中显示" |
| 删除行为 | 移到废纸篓 | 移到回收站 | 移到回收站 |
| 路径分隔符 | `/` | `\`（显示）/ `/`（存储） | `/` |
| 修饰键 | ⌘ (Command) | Ctrl | Ctrl |
| 删除键 | ⌘+⌫ (Backspace) | Delete | Delete |

#### 1.3 跨应用剪贴板技术方案

**核心挑战**：Electron 的 `clipboard` 模块只能写文本，无法直接写文件引用。

**解决方案**：使用 `clipboard.writeBuffer` 写入平台原生格式

```typescript
// macOS: 使用 NSFilenamesPboardType
clipboard.writeBuffer('NSFilenamesPboardType', Buffer.from(filePaths.join('\n')))

// Windows: 使用 CF_HDROP 格式（需要特殊编码）
// 或使用 electron 的 clipboard.write({ files: [...] }) (Electron 13+)

// 通用方案：Electron 13+ 支持
clipboard.write({
  text: filePath,  // 备用文本
  files: [filePath]  // 文件列表（macOS/Windows）
})
```

**剪切 vs 复制**：
- 复制：`clipboard.write({ files: [path] })`
- 剪切：`clipboard.write({ files: [path] })` + 应用内标记 `isCut = true`
- 粘贴时：如果 `isCut`，执行 `fs.rename`（移动）；否则 `fs.copyFile`（复制）

#### 1.4 技术实现

**前端（Renderer）**：
```
src/renderer/src/
├── components/
│   ├── ContextMenu.tsx          [新增] 右键菜单 UI
│   ├── ContextMenu.css          [新增] 菜单样式
│   └── FileTree.tsx             [修改] 添加右键事件
├── hooks/
│   ├── useContextMenu.ts        [新增] 菜单状态管理
│   └── useFileClipboard.ts      [新增] 剪贴板状态（剪切/复制）
└── contexts/
    └── ClipboardContext.tsx     [新增] 全局剪贴板上下文
```

**后端（Main Process）**：
```typescript
// 新增 IPC Handlers
ipcMain.handle('shell:showInFolder', (_, path) => shell.showItemInFolder(path))
ipcMain.handle('shell:trashItem', (_, path) => shell.trashItem(path))
ipcMain.handle('fs:rename', (_, oldPath, newPath) => fs.rename(oldPath, newPath))
ipcMain.handle('fs:copyFile', (_, src, dest) => fs.copyFile(src, dest))
ipcMain.handle('fs:copyDir', (_, src, dest) => fs.cp(src, dest, { recursive: true }))
ipcMain.handle('fs:moveFile', (_, src, dest) => fs.rename(src, dest))
ipcMain.handle('clipboard:writeFiles', (_, paths, isCut) => {
  clipboard.write({ files: paths })
  return { success: true, isCut }
})
ipcMain.handle('clipboard:readFiles', () => {
  // 读取剪贴板中的文件路径
  return clipboard.read('NSFilenamesPboardType') // macOS
})
ipcMain.handle('app:getPlatform', () => process.platform)
```

**Preload Bridge**：
```typescript
// 新增 API
showInFolder: (path: string) => ipcRenderer.invoke('shell:showInFolder', path),
trashItem: (path: string) => ipcRenderer.invoke('shell:trashItem', path),
renameFile: (oldPath: string, newPath: string) => ipcRenderer.invoke('fs:rename', oldPath, newPath),
copyFile: (src: string, dest: string) => ipcRenderer.invoke('fs:copyFile', src, dest),
copyDir: (src: string, dest: string) => ipcRenderer.invoke('fs:copyDir', src, dest),
moveFile: (src: string, dest: string) => ipcRenderer.invoke('fs:moveFile', src, dest),
clipboardWriteFiles: (paths: string[], isCut: boolean) => ipcRenderer.invoke('clipboard:writeFiles', paths, isCut),
clipboardReadFiles: () => ipcRenderer.invoke('clipboard:readFiles'),
getPlatform: () => ipcRenderer.invoke('app:getPlatform'),
```

---

### 2. 虚拟滚动（性能优化）

#### 2.1 问题场景
- 大型 Markdown 文件（>5000 行）渲染卡顿
- 含大量代码块/公式的文件渲染慢

#### 2.2 技术方案（推荐方案 C）

**方案 C：分段渲染 + Intersection Observer**
- 将 Markdown 按 heading 分段
- 使用 Intersection Observer 懒加载可视区域
- 优点：实现简单，效果好，兼容动态高度

#### 2.3 实现步骤
1. Markdown 内容按 `## ` 标题分段
2. 每段包裹在 `<section data-section-id="n">` 中
3. 使用 Intersection Observer 检测可视区域
4. 未进入可视区域的段落显示骨架屏占位
5. 滚动时动态渲染，离开可视区域后保留（避免抖动）

#### 2.4 文件变更
```
src/renderer/src/
├── components/
│   ├── MarkdownRenderer.tsx     [修改] 分段渲染逻辑
│   └── MarkdownSection.tsx      [新增] 单段渲染组件
└── hooks/
    └── useIntersectionObserver.ts [新增]
```

---

### 3. 测试覆盖率提升（质量保证）

#### 3.1 当前覆盖率

| 文件 | 当前 | 目标 |
|------|------|------|
| App.tsx | 41% | 70% |
| markdownRenderer.ts | 0% | 80% |
| logger.ts | 0% | 70% |
| components/index.ts | 0% | 100% |
| **总体** | **55%** | **70%** |

#### 3.2 需要新增的测试

**App.tsx 测试**：
- 文件夹打开流程
- 标签页切换/关闭
- 文件监听刷新
- 导出 HTML/PDF

**markdownRenderer.ts 测试**：
- 基础 Markdown 渲染
- KaTeX 公式渲染
- Mermaid 图表渲染
- 代码高亮

**ContextMenu 测试**：
- 菜单显示/隐藏
- 各菜单项点击
- 快捷键触发
- 跨平台文案

---

### 4. 主题切换 UI（锦上添花）

#### 4.1 当前状态
- 已有 CSS 变量支持明暗主题
- 跟随系统主题自动切换

#### 4.2 新增功能
- 标题栏添加主题切换按钮
- 三档：🌓 自动 / ☀️ 亮色 / 🌙 暗色
- 主题偏好持久化到 electron-store

---

## 二、开发阶段划分

### 阶段 1：右键菜单基础版

**范围**：
- ✅ 右键菜单 UI 组件
- ✅ 在 Finder 中显示
- ✅ 复制路径 / 复制相对路径
- ✅ 重命名（内联编辑）
- ✅ 删除（静默移到回收站）
- ✅ 键盘快捷键支持

**文件变更**：
```
src/
├── renderer/src/
│   ├── components/
│   │   ├── ContextMenu.tsx      [新增]
│   │   ├── ContextMenu.css      [新增]
│   │   ├── FileTree.tsx         [修改]
│   │   └── index.ts             [修改]
│   └── hooks/
│       └── useContextMenu.ts    [新增]
├── main/index.ts                [修改]
└── preload/index.ts             [修改]
```

### 阶段 2：剪切/复制/粘贴（跨应用）

**范围**：
- ✅ 复制文件到系统剪贴板
- ✅ 剪切文件
- ✅ 粘贴文件（支持文件夹递归复制）
- ✅ 剪贴板状态上下文

**技术难点**：
- 跨应用剪贴板格式兼容
- 文件夹递归复制
- 剪切后粘贴 = 移动（需要追踪剪切状态）

### 阶段 3：测试覆盖率提升

**范围**：
- App.tsx 测试补全
- markdownRenderer.ts 测试
- ContextMenu 组件测试
- logger.ts 测试

**目标**：覆盖率 55% → 70%

### 阶段 4：虚拟滚动

**范围**：
- MarkdownRenderer 分段渲染
- Intersection Observer 懒加载
- 骨架屏占位

### 阶段 5：主题切换 UI

**范围**：
- 主题切换按钮
- 三档切换逻辑
- 持久化存储

---

## 三、风险与依赖

### 风险点

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 跨应用剪贴板兼容性 | 高 | 优先实现 macOS，Windows 单独适配 |
| 文件夹递归复制性能 | 中 | 大文件夹显示进度条 |
| 重命名时文件监听触发 | 中 | 重命名时临时暂停监听 |
| 虚拟滚动与 Mermaid 渲染冲突 | 高 | Mermaid 段落强制预渲染 |
| 快捷键与系统冲突 | 低 | 使用标准快捷键组合 |

### 依赖项

| 功能 | 依赖 |
|------|------|
| 右键菜单 | 无新依赖，使用原生 React |
| 跨应用剪贴板 | Electron clipboard API（已内置） |
| 虚拟滚动 | 无新依赖，使用 Intersection Observer |
| 测试 | 现有 vitest + @testing-library/react |

---

## 四、验收标准

### 功能验收

- [ ] 右键菜单在文件上正确显示
- [ ] 右键菜单在文件夹上正确显示
- [ ] "在 Finder 中显示" 在 macOS/Windows/Linux 正常工作
- [ ] 复制路径/相对路径正确写入剪贴板
- [ ] 复制文件后可粘贴到 Finder/资源管理器
- [ ] 剪切文件后粘贴 = 移动文件
- [ ] 重命名支持内联编辑 + Enter 确认 + Esc 取消
- [ ] 删除静默移到回收站
- [ ] 所有快捷键正常工作
- [ ] 大文件（10000+ 行）渲染流畅

### 质量验收

- [ ] 测试覆盖率 ≥ 70%
- [ ] 无 TypeScript 类型错误
- [ ] ESLint 无警告
- [ ] 所有现有测试通过
- [ ] 新增功能有对应测试

### 性能验收

- [ ] 右键菜单弹出 < 50ms
- [ ] 5000 行文件首次渲染 < 1s
- [ ] 滚动 FPS > 30
- [ ] 文件夹复制有进度反馈

---

## 五、文件变更汇总

### 新增文件
```
src/renderer/src/
├── components/
│   ├── ContextMenu.tsx
│   ├── ContextMenu.css
│   └── MarkdownSection.tsx
├── hooks/
│   ├── useContextMenu.ts
│   ├── useFileClipboard.ts
│   └── useIntersectionObserver.ts
└── contexts/
    └── ClipboardContext.tsx

src/renderer/test/
├── components/
│   └── ContextMenu.test.tsx
└── utils/
    └── markdownRenderer.test.ts
```

### 修改文件
```
src/renderer/src/components/FileTree.tsx
src/renderer/src/components/MarkdownRenderer.tsx
src/renderer/src/components/index.ts
src/main/index.ts
src/preload/index.ts
src/preload/index.d.ts
```

---

## 六、开发顺序建议

```
阶段 1（右键菜单基础）
    ↓
阶段 2（剪切/复制/粘贴）
    ↓
阶段 3（测试覆盖率）← 此时有完整功能可测
    ↓
阶段 4（虚拟滚动）
    ↓
阶段 5（主题 UI）
    ↓
v1.2 发布
```

---

**文档版本**：v1.1
**创建日期**：2026-01-03
**更新日期**：2026-01-03
**作者**：AI Assistant
**状态**：✅ 需求已确认
