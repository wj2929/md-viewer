# MD Viewer v1.4.6 方案综合评审报告

> **评审日期**: 2026-01-13
> **评审工具**: 架构评审 Agent + 安全审计 Agent + 思考模式 + 代码验证
> **结论**: ❌ **原方案不可行，需要重大修订**

---

## 🚨 执行摘要

**原方案致命缺陷**: 试图通过修改 DOMPurify 配置解决问题，但没有意识到 markdown-it 的 `html: false` 配置会在渲染阶段就将所有 HTML 标签转义为 `&lt;` 和 `&gt;`，导致 DOMPurify 配置修改完全无效。

**核心矛盾**: v1.4.4 为了修复 XSS 设置了 `html: false`，但现在的需求又要求支持 HTML 标签（表格、`<br>`）。这是一个架构级别的矛盾，不能通过配置"打补丁"解决。

**评审结论**:
- 原方案: ❌ **技术上无效，必须重新设计**
- 推荐方案: ✅ **markdown-it `html: true` + DOMPurify 严格白名单（分层防御）**

---

## 📊 评审分数卡

| 维度 | 原方案 | 推荐方案 |
|------|--------|----------|
| **技术可行性** | 0/10 (无效) | 9/10 |
| **安全性** | N/A | 8/10 |
| **架构一致性** | 2/10 | 9/10 |
| **实施风险** | 高（方案无效）| 中（需要严格测试）|
| **维护成本** | N/A | 中 |
| **工期准确性** | 错误（1.5天无法完成）| 准确（1-1.5天）|

---

## 🔍 详细分析

### 问题 1: 原方案的根本错误

#### 代码证据

**文件**: `src/renderer/src/utils/markdownRenderer.ts:30`
```typescript
const md: MarkdownIt = new MarkdownIt({
  html: false,  // 🔒 安全修复: 禁用 HTML 以防止 XSS 攻击
  // ...
})
```

**Markdown 渲染流程**:
```
用户文件 (含 <br> 标签)
    ↓
markdown-it 解析 (html: false)
    ↓
HTML 标签被转义为 &lt;br&gt;
    ↓
DOMPurify 消毒
    ↓  (接收到的已经是转义后的文本)
浏览器渲染
    ↓
显示为字符串 "<br>"
```

**原方案的修改**:
```typescript
// 试图通过 DOMPurify 配置允许 <br>
ADD_TAGS: ['br', ...]
```

**为什么无效**: DOMPurify 工作在 HTML 消毒阶段，而 markdown-it 的转义发生在更早的渲染阶段。DOMPurify 永远看不到 `<br>` 标签，只能看到 `&lt;br&gt;` 文本。

#### 架构矛盾

```
v1.4.4 安全修复 ───→ html: false (防止 XSS)
                         ↓
v1.4.6 功能需求 ───→ 需要支持 HTML 标签
                         ↓
                     ❌ 矛盾！
```

这不是一个可以通过配置调整解决的问题，而是需要重新设计安全架构。

---

### 问题 2: 安全风险评估

#### 原方案的安全问题

假设原方案神奇地生效了（实际不会），会引入以下风险：

| 风险 | 严重程度 | 攻击向量 |
|------|----------|----------|
| CSS 注入 | 🔴 严重 | `style` 属性不受限制 |
| DOM Clobbering | 🔴 高 | `id` 属性可覆盖全局对象 |
| Class 劫持 | 🟡 中 | `class` 属性无白名单 |
| XSS (如果 html: true) | 🔴 严重 | DOMPurify 配置不够严格 |

#### 推荐方案的安全架构

```
┌─────────────────────────────────────────┐
│ 第一层防御: markdown-it                  │
│ - html: true (允许灵活性)                │
│ - 渲染 Markdown → HTML                   │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│ 第二层防御: DOMPurify (核心安全层)       │
│ - ALLOWED_TAGS (显式白名单)             │
│ - ALLOWED_ATTR (严格限制属性)           │
│ - ALLOWED_STYLES (安全 CSS 属性)        │
│ - FORBID_TAGS (禁止危险标签)            │
│ - FORBID_ATTR (禁止事件属性)            │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│ 第三层防御: Hooks (运行时验证)           │
│ - class 白名单验证                       │
│ - id 安全前缀验证                        │
│ - iframe sandbox 强制                   │
└──────────────┬──────────────────────────┘
               ↓
          安全的 HTML
```

**关键原则**:
1. **分层防御** - 单点失效不会导致整体失败
2. **最小权限** - 只允许必要的标签和属性
3. **默认拒绝** - 白名单模式而非黑名单
4. **纵深检测** - 不只检查标签，还检查属性、样式、URL

---

### 问题 3: Mermaid 版本混乱

#### 原方案的问题

```json
// 原方案提议
"mermaid": "^11.4.0"  // ← 实际上是降级！

// 当前版本
"mermaid": "^11.12.2"  // ← 已经是更新的版本
```

**问题分析**:
1. 没有查看 package.json，盲目提议升级
2. 11.4.0 比 11.12.2 旧，这是降级而非升级
3. 没有评估 Mermaid 升级的 breaking changes

#### 正确做法

1. **先验证当前版本**: 检查 11.12.2 是否支持 Sankey
2. **查看配置**: 检查 Mermaid 初始化是否包含 `sankey` 配置
3. **如果需要升级**: 查看 changelog，评估风险

**根因分析**: Sankey 图表显示配置代码，可能的原因：
- Mermaid 初始化缺少 `sankey` 配置项
- Sankey 语法错误（但用户提供的语法看起来正确）
- Mermaid 渲染时机问题（动态内容）

**推荐方案**: 先修复配置，不盲目升级版本。

---

## ✅ 推荐的正确方案

### 核心架构

```typescript
// 文件: src/renderer/src/utils/markdownRenderer.ts

export function createMarkdownRenderer(): MarkdownIt {
  const md: MarkdownIt = new MarkdownIt({
    html: true,  // ✅ 允许 HTML（提供灵活性）
    linkify: true,
    typographer: true,
    breaks: true,
    highlight: /* 保持不变 */
  })

  // KaTeX 和其他插件保持不变
  return md
}

// 统一的 DOMPurify 配置
export const DOMPURIFY_CONFIG: DOMPurify.Config = {
  // 使用 ALLOWED_TAGS 而非 ADD_TAGS（更安全）
  ALLOWED_TAGS: [
    // Markdown 核心标签
    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
    'p', 'a', 'ul', 'ol', 'li', 'blockquote',
    'code', 'pre', 'strong', 'em', 'del', 's', 'u',
    'hr', 'br', 'img',

    // 表格标签
    'table', 'thead', 'tbody', 'tfoot', 'tr', 'th', 'td', 'caption',

    // 布局容器（必要时）
    'div', 'span',

    // KaTeX 需要的数学标签
    'math', 'semantics', 'mrow', 'mi', 'mn', 'mo',
    'msup', 'msub', 'mfrac', 'mroot', 'msqrt', 'annotation',

    // Mermaid/SVG 标签
    'svg', 'path', 'rect', 'circle', 'ellipse', 'line',
    'polyline', 'polygon', 'g', 'defs', 'use', 'text', 'tspan'
  ],

  ALLOWED_ATTR: [
    // 链接和图片
    'href', 'src', 'alt', 'title', 'target', 'rel',

    // 表格属性
    'width', 'height', 'colspan', 'rowspan', 'align', 'valign',

    // 样式和标识
    'class', 'id',  // 将通过 hooks 进一步验证
    'style',        // 将通过 ALLOWED_STYLES 限制

    // SVG/数学公式属性
    'xmlns', 'viewBox', 'd', 'fill', 'stroke', 'stroke-width',
    'x', 'y', 'x1', 'y1', 'x2', 'y2', 'rx', 'ry', 'cx', 'cy', 'r',
    'transform', 'aria-hidden', 'role',

    // Mermaid 属性
    'data-mermaid-code'
  ],

  // 严格限制 style 内容
  ALLOWED_STYLES: {
    '*': {
      // 尺寸（限制范围）
      'width': [/^(100|[1-9]?\d)(px|em|rem|%)$/],
      'height': [/^(100|[1-9]?\d)(px|em|rem|%)$/],

      // 对齐
      'text-align': [/^(left|center|right|justify)$/],
      'vertical-align': [/^(top|middle|bottom|baseline)$/],

      // 表格相关
      'border-collapse': [/^(collapse|separate)$/],
      'border-spacing': [/^\d{1,2}px$/],

      // 内外边距（限制范围）
      'margin': [/^(\d{1,2}(px|em|rem)(\s+\d{1,2}(px|em|rem))*)$/],
      'padding': [/^(\d{1,2}(px|em|rem)(\s+\d{1,2}(px|em|rem))*)$/]
    }
  },

  // 明确禁止危险标签
  FORBID_TAGS: [
    'script', 'style', 'link', 'meta', 'base',
    'object', 'embed', 'applet',
    'iframe',  // 单独处理，见 hooks
    'form', 'input', 'button', 'textarea', 'select',
    'video', 'audio', 'track', 'source'
  ],

  // 明确禁止事件属性
  FORBID_ATTR: [
    'onerror', 'onclick', 'onload', 'onmouseover', 'onfocus',
    'onblur', 'onchange', 'onsubmit', 'onkeydown', 'onkeyup',
    'onmousedown', 'onmouseup', 'onmousemove', 'onmouseenter',
    'onmouseleave', 'ondblclick', 'oncontextmenu', 'oninput',
    'formaction', 'form'
  ],

  // URL 协议白名单
  ALLOWED_URI_REGEXP: /^(?:(?:https?|mailto|tel):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,

  // 安全选项
  KEEP_CONTENT: false,  // 移除危险标签时不保留内容
  RETURN_DOM: false,
  RETURN_DOM_FRAGMENT: false,
  RETURN_TRUSTED_TYPE: false,
  SANITIZE_DOM: true,
  WHOLE_DOCUMENT: false,
  ALLOW_DATA_ATTR: false  // 禁止自定义 data 属性（除非白名单）
}

// 安全 hooks
export function setupDOMPurifyHooks(): void {
  // class 白名单
  const ALLOWED_CLASSES = new Set([
    'markdown-body', 'highlight', 'code-block',
    'table', 'table-bordered', 'table-striped',
    'text-left', 'text-center', 'text-right',
    'language-javascript', 'language-typescript', 'language-python',
    // 添加项目中实际使用的 class
  ])

  DOMPurify.addHook('uponSanitizeAttribute', (node, data) => {
    // 验证 class 属性
    if (data.attrName === 'class') {
      const classes = data.attrValue.split(/\s+/)
      const safeClasses = classes.filter(c => ALLOWED_CLASSES.has(c))
      if (safeClasses.length === 0) {
        data.keepAttr = false
      } else {
        data.attrValue = safeClasses.join(' ')
      }
    }

    // 验证 id 属性（防止 DOM Clobbering）
    if (data.attrName === 'id') {
      const dangerousIds = [
        'document', 'window', 'location', 'top', 'parent',
        'self', 'frames', 'cookie', 'getElementById',
        'getElementsByName', 'querySelector'
      ]

      // 只允许 md- 前缀的 id（用于锚点跳转）
      if (!data.attrValue.startsWith('md-') ||
          dangerousIds.includes(data.attrValue.toLowerCase())) {
        data.keepAttr = false
      }
    }
  })
}

// 导出消毒函数
export function sanitizeHtml(html: string): string {
  return DOMPurify.sanitize(html, DOMPURIFY_CONFIG)
}
```

### Mermaid 配置修复

```typescript
// 文件: src/renderer/src/components/VirtualizedMarkdown.tsx

useEffect(() => {
  mermaid.initialize({
    startOnLoad: false,
    theme: isDark ? 'dark' : 'default',
    securityLevel: 'loose',
    suppressErrorRendering: true,

    // ✅ 新增: Sankey 图表配置
    sankey: {
      width: 600,
      height: 400,
      linkColor: 'gradient',
      nodeAlignment: 'justify',
      useMaxWidth: true
    },

    // 保留其他图表配置
    flowchart: { useMaxWidth: true, htmlLabels: true },
    sequence: { useMaxWidth: true },
    gantt: { useMaxWidth: true },
    pie: { useMaxWidth: true }
  })
}, [isDark])
```

---

## 🧪 测试策略

### 1. XSS 防护测试

```typescript
// __tests__/security/xss-prevention.test.ts
import { sanitizeHtml } from '../utils/markdownRenderer'

describe('XSS Prevention', () => {
  const testCases = [
    {
      name: '阻止 script 标签',
      input: '<script>alert("xss")</script>',
      shouldNotContain: ['<script', 'alert']
    },
    {
      name: '阻止事件处理器',
      input: '<img src="x" onerror="alert(1)">',
      shouldNotContain: ['onerror', 'alert']
    },
    {
      name: '阻止 javascript: URI',
      input: '<a href="javascript:alert(1)">click</a>',
      shouldNotContain: ['javascript:']
    },
    {
      name: '阻止 CSS 注入',
      input: '<div style="background: url(javascript:alert(1))">test</div>',
      shouldNotContain: ['background', 'javascript:']
    },
    {
      name: '阻止 DOM Clobbering',
      input: '<div id="document">evil</div>',
      shouldNotContain: ['id="document"']
    }
  ]

  testCases.forEach(({ name, input, shouldNotContain }) => {
    test(name, () => {
      const clean = sanitizeHtml(input)
      shouldNotContain.forEach(str => {
        expect(clean).not.toContain(str)
      })
    })
  })
})
```

### 2. 功能回归测试

```typescript
// __tests__/rendering/markdown-features.test.ts
describe('Markdown Rendering - v1.4.6', () => {
  test('应正确渲染表格内的 <br> 标签', () => {
    const md = createMarkdownRenderer()
    const markdown = `| A<br>B | C |`
    const html = sanitizeHtml(md.render(markdown))
    expect(html).toContain('<br>')
    expect(html).not.toContain('&lt;br&gt;')
  })

  test('应正确渲染原生 HTML table', () => {
    const md = createMarkdownRenderer()
    const markdown = `<table><tr><td width="50%">test</td></tr></table>`
    const html = sanitizeHtml(md.render(markdown))
    expect(html).toContain('<table>')
    expect(html).toContain('width="50%"')
  })
})
```

---

## 📅 实施计划

| 阶段 | 任务 | 工期 | 风险 |
|------|------|------|------|
| 1 | 修改 markdown-it 配置 (html: true) | 30分钟 | 低 |
| 2 | 重构 DOMPurify 配置 (ALLOWED_TAGS) | 2小时 | 中 |
| 3 | 实现 DOMPurify hooks (class/id 验证) | 1.5小时 | 低 |
| 4 | 同步 markdownRenderer.ts 和 VirtualizedMarkdown.tsx | 1小时 | 低 |
| 5 | 修复 Mermaid Sankey 配置 | 1小时 | 低 |
| 6 | 编写 XSS 防护测试 | 2小时 | - |
| 7 | 回归测试（所有 Markdown 功能） | 1小时 | 中 |
| 8 | 手动安全测试（恶意 Markdown 文件） | 30分钟 | - |
| 9 | 文档更新 (CHANGELOG, README, PROGRESS) | 30分钟 | - |
| **总计** | **10小时（1.5个工作日）** | - | **中** |

---

## 🎯 预期结果

### 修复前 vs 修复后

| 问题 | 修复前 | 修复后 |
|------|--------|--------|
| 表格内 `<br>` | ❌ 显示为 `<br>` 文本 | ✅ 正确换行 |
| HTML `<table>` | ❌ 显示为源码 `&lt;table&gt;` | ✅ 渲染为表格 |
| Mermaid Sankey | ❌ 显示配置代码 | ✅ 渲染为流向图 |
| XSS 防护 | ⚠️ v1.4.4 基础防护 | ✅ **增强的分层防御** |
| 架构一致性 | ❌ 预览和导出配置不同 | ✅ 统一配置 |
| 安全评级 | B（依赖 html: false） | A-（分层防御 + 白名单）|

---

## ⚠️ 风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| DOMPurify 绕过 | 低 | 高 | 严格的白名单 + hooks + 定期更新 |
| 破坏现有功能 | 中 | 高 | 完整的回归测试 |
| 性能下降 | 低 | 中 | 性能测试（大文件渲染） |
| Mermaid 兼容性 | 低 | 中 | 验证所有图表类型 |

---

## 📝 关键决策

### 决策 1: 不支持 Marp

**理由**:
- Marp 使用独立的 Marpit 引擎，与 markdown-it 不兼容
- 技术成本高（需要重写渲染逻辑）
- 维护成本高（Marp 生态独立更新）
- 用户定位不符（MD Viewer 是通用预览器，Marp 是演示文稿工具）

**备选方案**: 在 README 中添加说明，推荐用户使用官方 Marp CLI 或 VS Code 插件。

### 决策 2: v1.4.6 实施基础安全 hooks，完整系统延后到 v1.4.7

**理由**:
- 平衡功能需求和开发周期
- 基础 hooks（class/id 验证）已足够安全
- 完整的 hooks 系统（iframe sandbox、URL 验证等）可以作为增强

**v1.4.7 计划**:
- iframe 域名白名单和强制 sandbox
- URL 协议更严格的验证
- CSP (Content Security Policy) 支持
- 安全审计日志

### 决策 3: 不盲目升级 Mermaid

**理由**:
- 当前版本 11.12.2 已经是较新版本
- Mermaid 11.x breaking changes 较多
- 先修复配置，验证是否能解决问题

**验证步骤**:
1. 检查当前版本是否支持 Sankey
2. 添加 `sankey` 初始化配置
3. 测试用户提供的 Sankey 图表
4. 如果仍然失败，查看 Mermaid changelog 再决定升级

---

## 🔗 相关文档

1. [DOMPurify 官方文档](https://github.com/cure53/DOMPurify)
2. [markdown-it 官方文档](https://github.com/markdown-it/markdown-it)
3. [Mermaid Sankey 文档](https://mermaid.js.org/syntax/sankey.html)
4. [OWASP XSS Prevention Cheat Sheet](https://cheatsheetsecurity.org/cheatsheets/xss-prevention-cheat-sheet/)

---

## 🎓 经验教训

### 原方案的问题根源

1. **缺少根因分析** - 只看到表象（<br> 不渲染），没有深入分析根本原因（html: false 配置）
2. **架构矛盾未识别** - 没有意识到 v1.4.4 的安全修复与 v1.4.6 的功能需求冲突
3. **安全评估不足** - 放松 DOMPurify 限制但没有进行充分的安全分析
4. **盲目升级依赖** - 提议升级 Mermaid 但没有查看 changelog 和评估风险

### 正确的问题解决流程

```
1. 症状观察
   ↓
2. 根因分析 (使用调试工具、阅读源码)
   ↓
3. 架构评估 (识别矛盾和约束)
   ↓
4. 方案设计 (权衡安全性、可行性、成本)
   ↓
5. 安全审查 (威胁建模、风险评估)
   ↓
6. 原型验证 (小范围测试)
   ↓
7. 完整实施
   ↓
8. 测试验证 (功能 + 安全 + 性能)
   ↓
9. 文档更新
```

---

## ✅ 最终建议

1. **拒绝原方案** - 技术上不可行，必须重新设计
2. **采纳架构评审 Agent 的核心方案** - markdown-it html: true + DOMPurify 严格白名单
3. **实施安全审计 Agent 的关键安全措施** - class/id hooks，安全的 ALLOWED_STYLES
4. **延后完整 hooks 系统到 v1.4.7** - 平衡开发周期和安全性
5. **不支持 Marp** - 添加文档说明，推荐官方工具
6. **先修复 Mermaid 配置再考虑升级** - 降低风险

---

**评审人**: 架构评审 Agent + 安全审计 Agent + 思考模式
**建议实施**: ✅ 推荐方案
**风险等级**: 🟡 中等（需严格测试）
**预期收益**: 🟢 高（解决三个渲染问题 + 增强安全性）

