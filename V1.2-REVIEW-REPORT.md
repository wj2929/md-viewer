# MD Viewer v1.2 综合审批报告

> **文档类型**：专家评审报告
> **评审日期**：2026-01-03
> **评审方**：架构师 / 前端专家 / 安全审计师 / 测试专家 / AI 思考分析
> **被评审文档**：V1.2-IMPLEMENTATION-PLAN.md

---

## 一、综合评审结论

### 🟡 **有条件通过**

实施方案整体思路清晰，但存在 **3 个阻塞性问题** 和 **5 个需改进问题**，必须在开发前修正。

| 评审维度 | 评分 | 结论 |
|----------|------|------|
| 架构设计 | 6.5/10 | 有条件通过 |
| 前端设计 | 5/10 | 需修改 |
| 安全性 | 4/10 | **有高危漏洞** |
| 测试方案 | 4/10 | 不及格 |
| **综合** | **5/10** | **有条件通过** |

---

## 二、阻塞性问题（P0 - 必须修正）

### 🚨 问题 1：路径穿越安全漏洞

**严重程度**：高危

**问题描述**：
- 所有 IPC handlers 直接接受路径参数，没有任何校验
- 攻击者可通过渲染进程执行任意文件操作

**攻击示例**：
```typescript
window.api.trashItem('/etc/passwd')
window.api.readFile('/Users/mac/.ssh/id_rsa')
window.api.rename('/etc/hosts', '/etc/hosts.bak')
```

**影响范围**：
- ❌ 现有 v1.1.1 代码也存在此问题（fs:readFile, fs:readDir）
- ❌ v1.2 新增的所有 fs/shell handlers 都受影响

**必须的修复措施**：

```typescript
// 1. 实现路径白名单校验
let allowedBasePath: string | null = null

function isPathAllowed(targetPath: string): boolean {
  if (!allowedBasePath) return false
  const normalized = path.resolve(targetPath)
  return normalized.startsWith(allowedBasePath + path.sep)
}

function validatePath(targetPath: string): void {
  if (!isPathAllowed(targetPath)) {
    throw new Error(`安全错误：不允许访问 ${targetPath}`)
  }
}

// 2. 添加受保护路径黑名单
const PROTECTED_PATTERNS = [
  /^\/etc\//,
  /^\/usr\//,
  /^\/System\//,
  /\.ssh\//,
  /\.gnupg\//
]

// 3. 在所有 IPC handler 前调用校验
ipcMain.handle('shell:trashItem', async (_, filePath: string) => {
  validatePath(filePath)  // 必须添加
  // ...
})
```

---

### 🚨 问题 2：剪贴板 API 技术调研错误

**严重程度**：阻塞

**问题描述**：
```typescript
// ❌ 方案中的代码 - 此 API 不存在！
clipboard.write({
  files: paths  // Electron clipboard 没有这个属性
})
```

**Electron 实际支持的剪贴板方法**：
- `clipboard.writeText(text)`
- `clipboard.writeHTML(html)`
- `clipboard.writeBuffer(format, buffer)`
- `clipboard.write({ text, html, image, rtf, bookmark })`

**注意**：`files` 属性不存在！

**修复方案**：

**方案 A：使用平台特定 Buffer（复杂）**
```typescript
// macOS
import plist from 'plist'
clipboard.writeBuffer(
  'NSFilenamesPboardType',
  Buffer.from(plist.build(filePaths))
)

// Windows - 需要构造 CF_HDROP 格式
// 实现复杂，约 100 行代码
```

**方案 B：降级为应用内剪贴板（推荐）**
```typescript
// 只在应用内共享剪贴板状态
global.clipboardState = { paths, isCut }

// 同时写入路径文本（可粘贴为文本）
clipboard.writeText(paths.join('\n'))
```

**建议**：v1.2 采用方案 B，跨应用复制延期到 v1.3。

---

### 🚨 问题 3：Chromium 沙箱被禁用

**严重程度**：高危

**当前配置**：
```typescript
webPreferences: {
  sandbox: false,  // ❌ 危险
}
```

**风险**：如果渲染进程被攻破（如 XSS），攻击者可获得更大权限。

**修复措施**：
```typescript
webPreferences: {
  sandbox: true,  // ✅ 启用沙箱
  contextIsolation: true,
  nodeIntegration: false,
  webSecurity: true,
  allowRunningInsecureContent: false
}
```

**注意**：启用沙箱后需要测试 preload 脚本是否正常工作。

---

## 三、需改进问题（P1 - 影响质量）

### ⚠️ 问题 4：右键菜单技术选型争议

**架构师意见**：使用 Electron 原生 Menu
- ✅ 原生样式，用户体验一致
- ✅ 20 行代码实现全部功能
- ✅ 无需测试 UI 渲染逻辑

**前端专家意见**：可以用 React 组件
- ✅ 高度可定制
- ✅ 样式与应用一致
- ❌ 需要处理边界检测、键盘导航、多平台适配

**决策建议**：
| 场景 | 推荐方案 |
|------|----------|
| 追求原生体验 + 快速实现 | Electron Menu |
| 追求高度定制 + 与 VSCode 一致 | React 组件 |

**需要用户确认**：你更倾向哪种方案？

---

### ⚠️ 问题 5：ClipboardContext 性能问题

**问题**：React Context 更新会导致所有订阅组件重渲染

**场景**：
- 文件树有 1000 个文件项
- 每次剪切/复制操作，1000 个组件都会重渲染
- 这是性能灾难

**修复方案**：使用 Zustand 替代 Context

```typescript
// ✅ Zustand - 精准订阅
import { create } from 'zustand'

const useClipboardStore = create((set) => ({
  files: new Set(),
  isCut: false,
  copy: (paths) => set({ files: new Set(paths), isCut: false }),
  cut: (paths) => set({ files: new Set(paths), isCut: true })
}))

// 组件中精准订阅
function FileTreeItem({ path }) {
  const isCut = useClipboardStore((state) =>
    state.isCut && state.files.has(path)  // 只有自己被剪切时才重渲染
  )
}
```

---

### ⚠️ 问题 6：虚拟滚动方案过于简化

**问题**：
1. 手动实现 Intersection Observer 复杂度高
2. `estimateHeight` 无法准确估算（代码块、表格、图片高度不固定）
3. Mermaid 图表需要 DOM 存在才能渲染

**修复方案**：使用 react-virtuoso

```bash
npm install react-virtuoso
```

```typescript
import { Virtuoso } from 'react-virtuoso'

function VirtualizedMarkdown({ sections }) {
  return (
    <Virtuoso
      data={sections}
      itemContent={(index, section) => (
        <MarkdownSection content={section.content} />
      )}
      increaseViewportBy={{ top: 200, bottom: 600 }}
    />
  )
}
```

---

### ⚠️ 问题 7：测试覆盖率目标过低

**当前目标**：70%
**建议目标**：**80%**

| 模块 | 当前覆盖率 | 原目标 | 修正后目标 |
|------|-----------|--------|-----------|
| App.tsx | 41% | 70% | **75%** |
| markdownRenderer.ts | 0% | - | **100%** |
| logger.ts | 0% | 70% | **100%** |
| ContextMenu | 0% | 85% | **90%** |
| **总体** | **55%** | 70% | **≥80%** |

**缺失的测试**：
- 导出功能完整测试（+7 用例）
- 错误处理测试（+8 用例）
- 右键菜单边界测试（+12 用例）
- 剪贴板操作测试（+10 用例）
- E2E 测试（完全缺失）

---

### ⚠️ 问题 8：缺少 E2E 测试计划

**缺失场景**：
1. 完整文件操作流程（复制→粘贴→重命名→删除）
2. 跨应用剪贴板（复制到 Finder）
3. 虚拟滚动性能（10000 行文件）
4. 文件监听自动刷新

**建议**：使用 Playwright 补充 E2E 测试

---

## 四、评审意见汇总

### 架构师评审

> **结论**：有条件通过
>
> **核心问题**：
> 1. 右键菜单用 React 组件是过度设计
> 2. 剪贴板 API 理解错误
> 3. 虚拟滚动设计过于简化
>
> **建议**：
> - 使用 Electron Menu 实现右键菜单
> - 降级剪贴板为应用内
> - 使用 react-virtuoso

### 前端专家评审

> **结论**：需修改
>
> **核心问题**：
> 1. ClipboardContext 会导致性能问题
> 2. 虚拟滚动方案不可行
> 3. ContextMenu 缺少边界检测
>
> **建议**：
> - 使用 Zustand 替代 Context
> - 使用 react-virtuoso
> - 补充 a11y 测试

### 安全审计师评审

> **结论**：有条件通过
>
> **高危问题**：
> 1. 路径穿越漏洞（P0）
> 2. 沙箱禁用（P0）
> 3. 剪贴板路径泄露（P1）
>
> **必须修复**：
> - 实现路径白名单校验
> - 启用 Chromium 沙箱
> - 添加受保护路径黑名单

### 测试专家评审

> **结论**：4/10 不及格
>
> **核心问题**：
> 1. 覆盖率目标 70% 太低
> 2. 新增模块测试缺失（约 70 个用例）
> 3. 完全没有 E2E 测试
>
> **建议**：
> - 目标提升到 80%
> - 补充边界条件测试
> - 添加 Playwright E2E 测试

---

## 五、修正后的实施建议

### 开发前必须完成（P0）

| # | 任务 | 负责 | 状态 |
|---|------|------|------|
| 1 | 实现 IPC 路径白名单校验 | 后端 | 待完成 |
| 2 | 添加受保护路径黑名单 | 后端 | 待完成 |
| 3 | 启用 Chromium 沙箱 | 后端 | 待完成 |
| 4 | 确认剪贴板方案（应用内/跨应用） | 产品 | 待确认 |
| 5 | 确认右键菜单方案（原生/自定义） | 产品 | 待确认 |

### 开发中同步进行（P1）

| # | 任务 | 负责 | 状态 |
|---|------|------|------|
| 6 | 使用 Zustand 替代 ClipboardContext | 前端 | 待完成 |
| 7 | 使用 react-virtuoso 实现虚拟滚动 | 前端 | 待完成 |
| 8 | 补充测试用例（+70 个） | 测试 | 待完成 |
| 9 | 添加 E2E 测试 | 测试 | 待完成 |

### 修正后的工作量估算

| 阶段 | 原工作量 | 修正后工作量 | 变化 |
|------|----------|-------------|------|
| 阶段 1（右键菜单） | 3-4 单元 | 2-3 单元（使用原生 Menu）| -25% |
| 阶段 2（剪贴板） | 2-3 单元 | 1-2 单元（降级为应用内）| -50% |
| 阶段 3（测试） | 2 单元 | 3-4 单元（覆盖率 80%）| +75% |
| 阶段 4（虚拟滚动） | 2-3 单元 | 1-2 单元（使用 virtuoso）| -33% |
| **安全修复** | 0 | 1 单元（新增）| +1 |
| **总计** | 9-12 单元 | 8-12 单元 | 约持平 |

---

## 六、待用户确认的决策

### 决策 1：右键菜单方案

| 选项 | 优点 | 缺点 |
|------|------|------|
| **A. Electron Menu（推荐）** | 原生体验、实现简单、无需测试 UI | 定制性低 |
| **B. React 组件** | 高度定制、样式一致 | 实现复杂、需处理边界 |

### 决策 2：剪贴板方案

| 选项 | 优点 | 缺点 |
|------|------|------|
| **A. 应用内剪贴板（推荐）** | 实现简单、无平台兼容问题 | 无法粘贴到 Finder |
| **B. 跨应用剪贴板** | 完整体验 | 实现复杂、需处理平台差异 |

**建议**：v1.2 采用方案 A，v1.3 升级到方案 B。

---

## 七、最终结论

### 方案状态：**有条件通过**

### 发布条件

**必须满足以下条件才能开始 v1.2 开发**：

1. ✅ 安全问题修复完成（路径校验 + 沙箱）
2. ✅ 剪贴板方案确认（应用内 or 跨应用）
3. ✅ 右键菜单方案确认（原生 or 自定义）
4. ✅ 更新实施方案文档

### 风险声明

如果按原方案执行：
- ❌ 存在可被利用的安全漏洞
- ❌ 性能问题（Context 重渲染）
- ❌ 技术实现会失败（剪贴板 API 不存在）
- ❌ 测试覆盖不足

修正后：
- ✅ 安全可控
- ✅ 性能良好
- ✅ 技术可行
- ✅ 质量有保障

---

**报告生成时间**：2026-01-03
**报告版本**：v1.0
**下一步**：等待用户确认决策点后，更新实施方案
