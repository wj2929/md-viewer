# MD Viewer v1.2 å®æ–½æ–¹æ¡ˆï¼ˆä¿®è®¢ç‰ˆï¼‰

> **é¡¹ç›®åç§°**ï¼šMD Viewer
> **ç‰ˆæœ¬**ï¼šv1.2
> **æ–‡æ¡£ç±»å‹**ï¼šå®æ–½æ–¹æ¡ˆ
> **åˆ›å»ºæ—¥æœŸ**ï¼š2026-01-03
> **ä¿®è®¢æ—¥æœŸ**ï¼š2026-01-03
> **çŠ¶æ€**ï¼šâœ… å®¡æ‰¹é€šè¿‡

---

## ã€‡ã€å®¡æ‰¹å†³ç­–è®°å½•

| å†³ç­–ç‚¹ | é€‰é¡¹ | å†³ç­– | ç†ç”± |
|--------|------|------|------|
| å³é”®èœå•æ–¹æ¡ˆ | A.Electron Menu / B.Reactç»„ä»¶ | **A** | åŸç”Ÿä½“éªŒã€å®ç°ç®€å•ã€æ— éœ€æµ‹è¯•UI |
| å‰ªè´´æ¿æ–¹æ¡ˆ | A.åº”ç”¨å†… / B.è·¨åº”ç”¨ | **A** | v1.2å…ˆå®ç°åº”ç”¨å†…ï¼Œè·¨åº”ç”¨å»¶æœŸv1.3 |
| çŠ¶æ€ç®¡ç† | Context / Zustand | **Zustand** | é¿å…Contexté‡æ¸²æŸ“é—®é¢˜ |
| è™šæ‹Ÿæ»šåŠ¨ | æ‰‹åŠ¨å®ç° / react-virtuoso | **react-virtuoso** | æˆç†Ÿç¨³å®šï¼Œæ”¯æŒåŠ¨æ€é«˜åº¦ |
| æµ‹è¯•è¦†ç›–ç‡ | 70% / 80% | **80%** | æ–°å¢åŠŸèƒ½éœ€è¦æ›´é«˜è¦†ç›– |

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 ç‰ˆæœ¬ç›®æ ‡

| ç›®æ ‡ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| å³é”®ä¸Šä¸‹æ–‡èœå• | Electron åŸç”Ÿ Menuï¼Œç±» VSCode ä½“éªŒ | P0 |
| åº”ç”¨å†…å‰ªè´´æ¿ | æ”¯æŒæ–‡ä»¶å¤åˆ¶/å‰ªåˆ‡/ç²˜è´´ï¼ˆåº”ç”¨å†…ï¼‰ | P0 |
| å®‰å…¨åŠ å›º | è·¯å¾„æ ¡éªŒ + æ²™ç®±å¯ç”¨ | P0 |
| è™šæ‹Ÿæ»šåŠ¨ | å¤§æ–‡ä»¶æ¸²æŸ“æ€§èƒ½ä¼˜åŒ– | P1 |
| æµ‹è¯•è¦†ç›–ç‡ | ä» 55% æå‡åˆ° 80% | P1 |
| ä¸»é¢˜åˆ‡æ¢ UI | æ‰‹åŠ¨åˆ‡æ¢æ˜æš—ä¸»é¢˜ | P2 |

### 1.2 æ ¸å¿ƒéœ€æ±‚ç¡®è®¤

| éœ€æ±‚ç‚¹ | å†³ç­– | å¤‡æ³¨ |
|--------|------|------|
| å³é”®èœå•å®ç° | **Electron Menu** | åŸç”Ÿä½“éªŒï¼Œ20è¡Œä»£ç  |
| å¤åˆ¶/å‰ªåˆ‡èŒƒå›´ | **åº”ç”¨å†…** | è·¨åº”ç”¨å»¶æœŸåˆ° v1.3 |
| æ–‡ä»¶å¤¹æ”¯æŒ | æ”¯æŒ | é€’å½’æ“ä½œ |
| åˆ é™¤ç¡®è®¤ | é™é»˜ç§»åˆ°å›æ”¶ç«™ | å¯æ¢å¤ |
| å¿«æ·é”®æ”¯æŒ | æ”¯æŒ | Electron Menu åŸç”Ÿæ”¯æŒ |

---

## äºŒã€å®‰å…¨åŠ å›ºï¼ˆå¼€å‘å‰å¿…é¡»å®Œæˆï¼‰

### 2.1 è·¯å¾„ç™½åå•æ ¡éªŒ

**å¿…é¡»åœ¨æ‰€æœ‰ IPC handlers å‰æ·»åŠ æ ¡éªŒ**

```typescript
// src/main/security.ts
import * as path from 'path'

let allowedBasePath: string | null = null

export function setAllowedBasePath(basePath: string): void {
  allowedBasePath = path.resolve(basePath)
}

export function isPathAllowed(targetPath: string): boolean {
  if (!allowedBasePath) return false
  const normalized = path.resolve(targetPath)
  return normalized.startsWith(allowedBasePath + path.sep)
         || normalized === allowedBasePath
}

export function validatePath(targetPath: string): void {
  if (!isPathAllowed(targetPath)) {
    throw new Error(`å®‰å…¨é”™è¯¯ï¼šè·¯å¾„ ${targetPath} ä¸åœ¨å…è®¸èŒƒå›´å†…`)
  }
}

// å—ä¿æŠ¤è·¯å¾„é»‘åå•
const PROTECTED_PATTERNS = [
  /^\/etc\//,
  /^\/usr\//,
  /^\/System\//,
  /^\/bin\//,
  /^\/sbin\//,
  /^C:\\Windows\\/i,
  /^C:\\Program Files/i,
  /\.ssh\//,
  /\.gnupg\//,
  /\.aws\//
]

export function isProtectedPath(targetPath: string): boolean {
  const normalized = path.resolve(targetPath)
  return PROTECTED_PATTERNS.some(pattern => pattern.test(normalized))
}

export function validateNotProtected(targetPath: string): void {
  if (isProtectedPath(targetPath)) {
    throw new Error('å®‰å…¨é”™è¯¯ï¼šæ— æ³•æ“ä½œå—ä¿æŠ¤çš„ç³»ç»Ÿè·¯å¾„')
  }
}
```

### 2.2 å¯ç”¨ Chromium æ²™ç®±

```typescript
// src/main/index.ts ä¿®æ”¹
webPreferences: {
  preload: join(__dirname, '../preload/index.js'),
  sandbox: true,  // âœ… å¯ç”¨æ²™ç®±
  contextIsolation: true,
  nodeIntegration: false,
  webSecurity: true,
  allowRunningInsecureContent: false
}
```

### 2.3 å®‰å…¨ä»»åŠ¡æ¸…å•

| # | ä»»åŠ¡ | çŠ¶æ€ |
|---|------|------|
| 2.1 | åˆ›å»º `src/main/security.ts` å®‰å…¨æ¨¡å— | å¾…å®Œæˆ |
| 2.2 | åœ¨ `dialog:openFolder` ä¸­è®¾ç½® `allowedBasePath` | å¾…å®Œæˆ |
| 2.3 | åœ¨æ‰€æœ‰ `fs:*` handlers æ·»åŠ  `validatePath()` | å¾…å®Œæˆ |
| 2.4 | åœ¨æ‰€æœ‰ `shell:*` handlers æ·»åŠ  `validatePath()` | å¾…å®Œæˆ |
| 2.5 | æ·»åŠ å—ä¿æŠ¤è·¯å¾„æ£€æŸ¥ | å¾…å®Œæˆ |
| 2.6 | ä¿®æ”¹ `sandbox: true` | å¾…å®Œæˆ |
| 2.7 | æµ‹è¯• preload åœ¨æ²™ç®±æ¨¡å¼ä¸‹æ­£å¸¸å·¥ä½œ | å¾…å®Œæˆ |

---

## ä¸‰ã€æŠ€æœ¯æ¶æ„ï¼ˆä¿®è®¢ç‰ˆï¼‰

### 3.1 å³é”®èœå•æ¶æ„ï¼ˆElectron Menuï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Renderer Process                      â”‚
â”‚  FileTree.tsx                                           â”‚
â”‚    â””â”€â”€ onContextMenu(e, file) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                                      â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”˜
                                                       â”‚
                         IPC: 'context-menu:show'      â”‚
                                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Main Process                          â”‚
â”‚  contextMenuHandler.ts                                  â”‚
â”‚    â”œâ”€â”€ Menu.buildFromTemplate(items)                    â”‚
â”‚    â”œâ”€â”€ menu.popup()                                     â”‚
â”‚    â””â”€â”€ å„èœå•é¡¹ click å›è°ƒ                               â”‚
â”‚         â”œâ”€â”€ shell.showItemInFolder()                    â”‚
â”‚         â”œâ”€â”€ clipboard.writeText()                       â”‚
â”‚         â”œâ”€â”€ shell.trashItem()                           â”‚
â”‚         â””â”€â”€ event.sender.send('file:rename', path)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 åº”ç”¨å†…å‰ªè´´æ¿æ¶æ„ï¼ˆZustandï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Renderer Process                      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Zustand Store: useClipboardStore                â”‚    â”‚
â”‚  â”‚  - files: Set<string>                           â”‚    â”‚
â”‚  â”‚  - isCut: boolean                               â”‚    â”‚
â”‚  â”‚  - copy(paths)                                  â”‚    â”‚
â”‚  â”‚  - cut(paths)                                   â”‚    â”‚
â”‚  â”‚  - paste(targetDir)                             â”‚    â”‚
â”‚  â”‚  - clear()                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                                             â”‚
â”‚           â–¼ ç²¾å‡†è®¢é˜…                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ FileTreeItem                                    â”‚    â”‚
â”‚  â”‚  const isCut = useClipboardStore(              â”‚    â”‚
â”‚  â”‚    state => state.isCut && state.files.has(path)â”‚    â”‚
â”‚  â”‚  )  // åªæœ‰è¢«å‰ªåˆ‡çš„é¡¹æ‰é‡æ¸²æŸ“                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 è™šæ‹Ÿæ»šåŠ¨æ¶æ„ï¼ˆreact-virtuosoï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MarkdownRenderer.tsx                                    â”‚
â”‚                                                         â”‚
â”‚  content â”€â”€â–º splitBySections() â”€â”€â–º sections[]           â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ <Virtuoso                                       â”‚    â”‚
â”‚  â”‚   data={sections}                               â”‚    â”‚
â”‚  â”‚   itemContent={(i, section) =>                  â”‚    â”‚
â”‚  â”‚     <MarkdownSection content={section} />       â”‚    â”‚
â”‚  â”‚   }                                             â”‚    â”‚
â”‚  â”‚   increaseViewportBy={{ top: 200, bottom: 600 }}â”‚    â”‚
â”‚  â”‚ />                                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â”‚  - è‡ªåŠ¨æµ‹é‡çœŸå®é«˜åº¦                                      â”‚
â”‚  - æ”¯æŒåŠ¨æ€å†…å®¹                                         â”‚
â”‚  - Mermaid è¿›å…¥å¯è§†åŒºåŸŸåæ¸²æŸ“                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€é˜¶æ®µåˆ’åˆ†ä¸ä»»åŠ¡åˆ†è§£ï¼ˆä¿®è®¢ç‰ˆï¼‰

### é˜¶æ®µ 0ï¼šå®‰å…¨åŠ å›ºï¼ˆå¼€å‘å‰ï¼‰

**ç›®æ ‡**ï¼šä¿®å¤å®‰å…¨æ¼æ´ï¼Œä¸ºåç»­å¼€å‘å¥ å®šå®‰å…¨åŸºç¡€

| # | ä»»åŠ¡ | ç±»å‹ | éªŒæ”¶æ ‡å‡† |
|---|------|------|----------|
| 0.1 | åˆ›å»º security.ts æ¨¡å— | å¼€å‘ | è·¯å¾„æ ¡éªŒå‡½æ•°å¯ç”¨ |
| 0.2 | ä¿®æ”¹ openFolder è®¾ç½®ç™½åå• | å¼€å‘ | æ‰“å¼€æ–‡ä»¶å¤¹åè®¾ç½® allowedBasePath |
| 0.3 | æ‰€æœ‰ fs handlers æ·»åŠ æ ¡éªŒ | å¼€å‘ | éæ³•è·¯å¾„æŠ›å‡ºé”™è¯¯ |
| 0.4 | æ‰€æœ‰ shell handlers æ·»åŠ æ ¡éªŒ | å¼€å‘ | éæ³•è·¯å¾„æŠ›å‡ºé”™è¯¯ |
| 0.5 | å¯ç”¨æ²™ç®±æ¨¡å¼ | å¼€å‘ | sandbox: true |
| 0.6 | å®‰å…¨æµ‹è¯• | æµ‹è¯• | è·¯å¾„ç©¿è¶Šæ”»å‡»è¢«é˜»æ­¢ |

**äº¤ä»˜ç‰©**ï¼š
- [ ] `src/main/security.ts`
- [ ] ä¿®æ”¹ `src/main/index.ts`
- [ ] å®‰å…¨æµ‹è¯•ç”¨ä¾‹

---

### é˜¶æ®µ 1ï¼šå³é”®èœå•ï¼ˆElectron Menuï¼‰

**ç›®æ ‡**ï¼šå®ç°åŸç”Ÿå³é”®èœå•ï¼Œæ”¯æŒåŸºæœ¬æ–‡ä»¶æ“ä½œ

| # | ä»»åŠ¡ | ç±»å‹ | éªŒæ”¶æ ‡å‡† |
|---|------|------|----------|
| 1.1 | åˆ›å»º contextMenuHandler.ts | å¼€å‘ | Menu æ„å»ºé€»è¾‘ |
| 1.2 | FileTree æ·»åŠ  onContextMenu | å¼€å‘ | å³é”®è§¦å‘ IPC |
| 1.3 | å®ç°ã€Œåœ¨ Finder ä¸­æ˜¾ç¤ºã€ | å¼€å‘ | è·¨å¹³å°æ­£å¸¸ |
| 1.4 | å®ç°ã€Œå¤åˆ¶è·¯å¾„ã€ | å¼€å‘ | è·¯å¾„å†™å…¥å‰ªè´´æ¿ |
| 1.5 | å®ç°ã€Œå¤åˆ¶ç›¸å¯¹è·¯å¾„ã€ | å¼€å‘ | ç›¸å¯¹è·¯å¾„æ­£ç¡® |
| 1.6 | å®ç°ã€Œé‡å‘½åã€ | å¼€å‘ | å†…è”ç¼–è¾‘ + IPC |
| 1.7 | å®ç°ã€Œåˆ é™¤ã€ | å¼€å‘ | ç§»åˆ°å›æ”¶ç«™ |
| 1.8 | å®ç°ã€Œå¯¼å‡º HTMLã€ | å¼€å‘ | æœªæ‰“å¼€æ–‡ä»¶ä¹Ÿèƒ½å¯¼å‡º |
| 1.9 | å®ç°ã€Œå¯¼å‡º PDFã€ | å¼€å‘ | æœªæ‰“å¼€æ–‡ä»¶ä¹Ÿèƒ½å¯¼å‡º |
| 1.10 | è·¨å¹³å°èœå•æ–‡æ¡ˆ | å¼€å‘ | darwin/win32/linux |
| 1.11 | ä¾§è¾¹æ æ·»åŠ åˆ·æ–°æŒ‰é’® | å¼€å‘ | æ‰‹åŠ¨åˆ·æ–°æ–‡ä»¶æ ‘ |
| 1.12 | é˜¶æ®µ 1 æµ‹è¯• | æµ‹è¯• | IPC è°ƒç”¨æµ‹è¯• |

**æŠ€æœ¯å®ç°**ï¼š

```typescript
// src/main/contextMenuHandler.ts
import { Menu, shell, clipboard, BrowserWindow } from 'electron'
import * as path from 'path'
import { validatePath, validateNotProtected } from './security'

interface FileInfo {
  name: string
  path: string
  isDirectory: boolean
}

export function showContextMenu(
  window: BrowserWindow,
  file: FileInfo,
  basePath: string
): void {
  const platform = process.platform

  const template = [
    {
      label: platform === 'darwin' ? 'åœ¨ Finder ä¸­æ˜¾ç¤º'
           : platform === 'win32' ? 'åœ¨èµ„æºç®¡ç†å™¨ä¸­æ˜¾ç¤º'
           : 'åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æ˜¾ç¤º',
      click: () => {
        validatePath(file.path)
        shell.showItemInFolder(file.path)
      }
    },
    { type: 'separator' },
    {
      label: 'å¤åˆ¶è·¯å¾„',
      accelerator: 'CmdOrCtrl+Alt+C',
      click: () => clipboard.writeText(file.path)
    },
    {
      label: 'å¤åˆ¶ç›¸å¯¹è·¯å¾„',
      accelerator: 'Shift+Alt+C',
      click: () => {
        const relativePath = path.relative(basePath, file.path)
        clipboard.writeText(relativePath)
      }
    },
    { type: 'separator' },
    {
      label: 'å¤åˆ¶',
      accelerator: 'CmdOrCtrl+C',
      click: () => window.webContents.send('clipboard:copy', [file.path])
    },
    {
      label: 'å‰ªåˆ‡',
      accelerator: 'CmdOrCtrl+X',
      click: () => window.webContents.send('clipboard:cut', [file.path])
    },
    ...(file.isDirectory ? [{
      label: 'ç²˜è´´',
      accelerator: 'CmdOrCtrl+V',
      click: () => window.webContents.send('clipboard:paste', file.path)
    }] : []),
    { type: 'separator' },
    // å¯¼å‡ºåŠŸèƒ½ï¼ˆä»…æ–‡ä»¶ï¼‰
    ...(!file.isDirectory ? [
      {
        label: 'å¯¼å‡º HTML',
        click: async () => {
          validatePath(file.path)
          const content = await fs.readFile(file.path, 'utf-8')
          window.webContents.send('file:exportHTML', { path: file.path, content })
        }
      },
      {
        label: 'å¯¼å‡º PDF',
        click: async () => {
          validatePath(file.path)
          const content = await fs.readFile(file.path, 'utf-8')
          window.webContents.send('file:exportPDF', { path: file.path, content })
        }
      },
      { type: 'separator' }
    ] : []),
    {
      label: 'é‡å‘½å',
      accelerator: 'Enter',
      click: () => window.webContents.send('file:startRename', file.path)
    },
    {
      label: 'åˆ é™¤',
      accelerator: platform === 'darwin' ? 'Cmd+Backspace' : 'Delete',
      click: async () => {
        validatePath(file.path)
        validateNotProtected(file.path)
        await shell.trashItem(file.path)
        window.webContents.send('file:deleted', file.path)
      }
    }
  ]

  const menu = Menu.buildFromTemplate(template)
  menu.popup({ window })
}
```

**äº¤ä»˜ç‰©**ï¼š
- [ ] `src/main/contextMenuHandler.ts`
- [ ] FileTree.tsx å³é”®äº‹ä»¶
- [ ] FileTree.tsx åˆ·æ–°æŒ‰é’® UI
- [ ] App.tsx å¤„ç†å¯¼å‡ºäº‹ä»¶
- [ ] IPC handler: `context-menu:show`
- [ ] IPC event: `file:exportHTML`, `file:exportPDF`
- [ ] æµ‹è¯•ç”¨ä¾‹ï¼ˆ12+ï¼‰

**åˆ·æ–°æŒ‰é’®å®ç°**ï¼š

```typescript
// src/renderer/src/App.tsx
const handleRefresh = useCallback(async () => {
  if (!folderPath) return

  setIsLoading(true)
  try {
    const fileList = await window.api.readDir(folderPath)
    setFiles(fileList)
  } catch (error) {
    console.error('Failed to refresh files:', error)
  } finally {
    setIsLoading(false)
  }
}, [folderPath])

// UI (åœ¨ sidebar-header ä¸­)
<div className="sidebar-header-top">
  <span className="folder-name">{folderPath.split('/').pop()}</span>
  <div className="folder-actions">
    <button className="refresh-btn" onClick={handleRefresh} title="åˆ·æ–°">
      ğŸ”„
    </button>
    <button className="change-folder-btn" onClick={handleOpenFolder}>
      åˆ‡æ¢
    </button>
  </div>
</div>
```

---

### é˜¶æ®µ 2ï¼šåº”ç”¨å†…å‰ªè´´æ¿ï¼ˆZustandï¼‰

**ç›®æ ‡**ï¼šå®ç°åº”ç”¨å†…æ–‡ä»¶å¤åˆ¶/å‰ªåˆ‡/ç²˜è´´

| # | ä»»åŠ¡ | ç±»å‹ | éªŒæ”¶æ ‡å‡† |
|---|------|------|----------|
| 2.1 | å®‰è£… Zustand | é…ç½® | ä¾èµ–å®‰è£… |
| 2.2 | åˆ›å»º clipboardStore | å¼€å‘ | Store æ­£å¸¸å·¥ä½œ |
| 2.3 | FileTree é›†æˆå‰ªåˆ‡çŠ¶æ€ | å¼€å‘ | å‰ªåˆ‡é¡¹åŠé€æ˜ |
| 2.4 | å®ç°ç²˜è´´é€»è¾‘ | å¼€å‘ | å¤åˆ¶/ç§»åŠ¨æ–‡ä»¶ |
| 2.5 | å®ç°æ–‡ä»¶å¤¹é€’å½’å¤åˆ¶ | å¼€å‘ | å­æ–‡ä»¶å®Œæ•´å¤åˆ¶ |
| 2.6 | å†²çªå¤„ç†å¯¹è¯æ¡† | å¼€å‘ | åŒåæ–‡ä»¶æç¤º |
| 2.7 | é˜¶æ®µ 2 æµ‹è¯• | æµ‹è¯• | Store + æ–‡ä»¶æ“ä½œ |

**æŠ€æœ¯å®ç°**ï¼š

```typescript
// src/renderer/src/stores/clipboardStore.ts
import { create } from 'zustand'

interface ClipboardState {
  files: Set<string>
  isCut: boolean
  copy: (paths: string[]) => void
  cut: (paths: string[]) => void
  paste: (targetDir: string) => Promise<void>
  clear: () => void
  hasFiles: () => boolean
}

export const useClipboardStore = create<ClipboardState>((set, get) => ({
  files: new Set(),
  isCut: false,

  copy: (paths) => {
    set({ files: new Set(paths), isCut: false })
  },

  cut: (paths) => {
    set({ files: new Set(paths), isCut: true })
  },

  paste: async (targetDir) => {
    const { files, isCut } = get()
    if (files.size === 0) return

    for (const srcPath of files) {
      const fileName = srcPath.split('/').pop()!
      const destPath = `${targetDir}/${fileName}`

      if (isCut) {
        await window.api.moveFile(srcPath, destPath)
      } else {
        await window.api.copyFile(srcPath, destPath)
      }
    }

    // å‰ªåˆ‡åæ¸…ç©ºï¼Œå¤åˆ¶åä¿ç•™
    if (isCut) {
      set({ files: new Set(), isCut: false })
    }
  },

  clear: () => set({ files: new Set(), isCut: false }),

  hasFiles: () => get().files.size > 0
}))
```

**äº¤ä»˜ç‰©**ï¼š
- [ ] `npm install zustand`
- [ ] `src/renderer/src/stores/clipboardStore.ts`
- [ ] FileTree å‰ªåˆ‡çŠ¶æ€æ ·å¼
- [ ] å†²çªå¯¹è¯æ¡†ç»„ä»¶
- [ ] IPC handlers: `fs:copyFile`, `fs:copyDir`, `fs:moveFile`
- [ ] æµ‹è¯•ç”¨ä¾‹ï¼ˆ12+ï¼‰

---

### é˜¶æ®µ 3ï¼šæµ‹è¯•è¦†ç›–ç‡æå‡

**ç›®æ ‡**ï¼šæµ‹è¯•è¦†ç›–ç‡ä» 55% æå‡åˆ° 80%

| # | ä»»åŠ¡ | å½“å‰ | ç›®æ ‡ | æ–°å¢ç”¨ä¾‹ |
|---|------|------|------|----------|
| 3.1 | App.tsx æµ‹è¯• | 41% | 75% | +20 |
| 3.2 | markdownRenderer.ts æµ‹è¯• | 0% | 100% | +6 |
| 3.3 | logger.ts æµ‹è¯• | 0% | 100% | +6 |
| 3.4 | security.ts æµ‹è¯• | 0% | 100% | +10 |
| 3.5 | clipboardStore æµ‹è¯• | 0% | 90% | +12 |
| 3.6 | contextMenu IPC æµ‹è¯• | 0% | 85% | +8 |
| 3.7 | E2E æµ‹è¯• | 0% | - | +4 åœºæ™¯ |

**E2E æµ‹è¯•åœºæ™¯**ï¼š

```typescript
// e2e/file-operations.spec.ts
import { test, expect } from '@playwright/test'
import { _electron as electron } from 'playwright'

test('å®Œæ•´æ–‡ä»¶æ“ä½œæµç¨‹', async () => {
  const app = await electron.launch({ args: ['.'] })
  const window = await app.firstWindow()

  // 1. æ‰“å¼€æ–‡ä»¶å¤¹
  // 2. å³é”®æ–‡ä»¶ â†’ å¤åˆ¶
  // 3. å³é”®æ–‡ä»¶å¤¹ â†’ ç²˜è´´
  // 4. éªŒè¯æ–‡ä»¶è¢«å¤åˆ¶
  // 5. å³é”®æ–°æ–‡ä»¶ â†’ åˆ é™¤

  await app.close()
})
```

**äº¤ä»˜ç‰©**ï¼š
- [ ] App.test.tsx è¡¥å…¨
- [ ] markdownRenderer.test.ts
- [ ] logger.test.ts
- [ ] security.test.ts
- [ ] clipboardStore.test.ts
- [ ] e2e/file-operations.spec.ts
- [ ] è¦†ç›–ç‡æŠ¥å‘Š â‰¥ 80%

---

### é˜¶æ®µ 4ï¼šè™šæ‹Ÿæ»šåŠ¨ï¼ˆreact-virtuosoï¼‰

**ç›®æ ‡**ï¼šå¤§æ–‡ä»¶æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–

| # | ä»»åŠ¡ | ç±»å‹ | éªŒæ”¶æ ‡å‡† |
|---|------|------|----------|
| 4.1 | å®‰è£… react-virtuoso | é…ç½® | ä¾èµ–å®‰è£… |
| 4.2 | å®ç° splitBySections | å¼€å‘ | æŒ‰æ ‡é¢˜åˆ†æ®µ |
| 4.3 | åˆ›å»º MarkdownSection | å¼€å‘ | å•æ®µæ¸²æŸ“ |
| 4.4 | é›†æˆ Virtuoso | å¼€å‘ | è™šæ‹Ÿæ»šåŠ¨ç”Ÿæ•ˆ |
| 4.5 | Mermaid æ‡’åŠ è½½ | å¼€å‘ | å¯è§†åŒºåŸŸæ‰æ¸²æŸ“ |
| 4.6 | æ€§èƒ½æµ‹è¯• | æµ‹è¯• | 10000è¡Œ < 2s |

**æŠ€æœ¯å®ç°**ï¼š

```typescript
// src/renderer/src/components/VirtualizedMarkdown.tsx
import { Virtuoso } from 'react-virtuoso'
import { useMemo } from 'react'

interface Section {
  id: string
  content: string
  hasMermaid: boolean
}

function splitBySections(content: string): Section[] {
  const sections: Section[] = []
  const chunks = content.split(/(?=^#{1,2}\s)/m)

  chunks.forEach((chunk, i) => {
    if (chunk.trim()) {
      sections.push({
        id: `section-${i}`,
        content: chunk,
        hasMermaid: chunk.includes('```mermaid')
      })
    }
  })

  return sections
}

export function VirtualizedMarkdown({ content }: { content: string }) {
  const sections = useMemo(() => splitBySections(content), [content])

  // å°æ–‡ä»¶ç›´æ¥æ¸²æŸ“ï¼Œä¸ç”¨è™šæ‹Ÿæ»šåŠ¨
  if (sections.length < 10) {
    return <MarkdownRenderer content={content} />
  }

  return (
    <Virtuoso
      data={sections}
      itemContent={(index, section) => (
        <MarkdownSection
          key={section.id}
          content={section.content}
          hasMermaid={section.hasMermaid}
        />
      )}
      increaseViewportBy={{ top: 200, bottom: 600 }}
    />
  )
}
```

**äº¤ä»˜ç‰©**ï¼š
- [ ] `npm install react-virtuoso`
- [ ] `src/renderer/src/components/VirtualizedMarkdown.tsx`
- [ ] `src/renderer/src/components/MarkdownSection.tsx`
- [ ] æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
- [ ] æµ‹è¯•ç”¨ä¾‹ï¼ˆ6+ï¼‰

---

### é˜¶æ®µ 5ï¼šä¸»é¢˜åˆ‡æ¢ UI

**ç›®æ ‡**ï¼šæä¾›æ‰‹åŠ¨ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½

| # | ä»»åŠ¡ | ç±»å‹ | éªŒæ”¶æ ‡å‡† |
|---|------|------|----------|
| 5.1 | åˆ›å»º ThemeToggle ç»„ä»¶ | å¼€å‘ | æŒ‰é’®æ˜¾ç¤º |
| 5.2 | å®ç°ä¸‰æ¡£åˆ‡æ¢ | å¼€å‘ | è‡ªåŠ¨/äº®/æš— |
| 5.3 | æŒä¹…åŒ–åˆ° electron-store | å¼€å‘ | é‡å¯è®°ä½ |
| 5.4 | CSS å˜é‡åˆ‡æ¢ | å¼€å‘ | ä¸»é¢˜ç”Ÿæ•ˆ |
| 5.5 | é˜¶æ®µ 5 æµ‹è¯• | æµ‹è¯• | åˆ‡æ¢é€»è¾‘ |

**äº¤ä»˜ç‰©**ï¼š
- [ ] `src/renderer/src/components/ThemeToggle.tsx`
- [ ] `src/renderer/src/hooks/useTheme.ts`
- [ ] IPC handlers: `store:getTheme`, `store:setTheme`
- [ ] æµ‹è¯•ç”¨ä¾‹ï¼ˆ5+ï¼‰

---

## äº”ã€æ–‡ä»¶å˜æ›´æ±‡æ€»ï¼ˆä¿®è®¢ç‰ˆï¼‰

### æ–°å¢æ–‡ä»¶ï¼ˆ10 ä¸ªï¼‰

```
src/
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ security.ts              [æ–°å¢] å®‰å…¨æ¨¡å—
â”‚   â””â”€â”€ contextMenuHandler.ts    [æ–°å¢] å³é”®èœå•å¤„ç†
â”œâ”€â”€ renderer/src/
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â””â”€â”€ clipboardStore.ts    [æ–°å¢] Zustand Store
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ VirtualizedMarkdown.tsx  [æ–°å¢]
â”‚   â”‚   â”œâ”€â”€ MarkdownSection.tsx      [æ–°å¢]
â”‚   â”‚   â”œâ”€â”€ ConflictDialog.tsx       [æ–°å¢]
â”‚   â”‚   â””â”€â”€ ThemeToggle.tsx          [æ–°å¢]
â”‚   â””â”€â”€ hooks/
â”‚       â””â”€â”€ useTheme.ts              [æ–°å¢]
â””â”€â”€ test/
    â”œâ”€â”€ security.test.ts             [æ–°å¢]
    â””â”€â”€ clipboardStore.test.ts       [æ–°å¢]
```

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ6 ä¸ªï¼‰

```
src/main/index.ts           [ä¿®æ”¹] å®‰å…¨é…ç½® + IPC handlers
src/preload/index.ts        [ä¿®æ”¹] æ–°å¢ API
src/preload/index.d.ts      [ä¿®æ”¹] ç±»å‹å®šä¹‰
src/renderer/src/App.tsx    [ä¿®æ”¹] é›†æˆæ–°ç»„ä»¶
src/renderer/src/components/FileTree.tsx     [ä¿®æ”¹] å³é”® + å‰ªåˆ‡çŠ¶æ€
src/renderer/src/components/MarkdownRenderer.tsx [ä¿®æ”¹] è™šæ‹Ÿæ»šåŠ¨
```

### æ–°å¢ä¾èµ–

```bash
npm install zustand react-virtuoso
```

---

## å…­ã€IPC API æ¸…å•ï¼ˆä¿®è®¢ç‰ˆï¼‰

| é€šé“å | æ–¹å‘ | å‚æ•° | è¯´æ˜ |
|--------|------|------|------|
| `context-menu:show` | Râ†’M | `{file, basePath}` | æ˜¾ç¤ºå³é”®èœå• |
| `clipboard:copy` | Mâ†’R | `paths[]` | é€šçŸ¥å¤åˆ¶ |
| `clipboard:cut` | Mâ†’R | `paths[]` | é€šçŸ¥å‰ªåˆ‡ |
| `clipboard:paste` | Mâ†’R | `targetDir` | é€šçŸ¥ç²˜è´´ |
| `file:startRename` | Mâ†’R | `path` | å¼€å§‹é‡å‘½å |
| `file:deleted` | Mâ†’R | `path` | æ–‡ä»¶å·²åˆ é™¤ |
| `file:exportHTML` | Mâ†’R | `{path, content}` | å¯¼å‡º HTML |
| `file:exportPDF` | Mâ†’R | `{path, content}` | å¯¼å‡º PDF |
| `fs:rename` | Râ†’M | `old, new` | é‡å‘½åæ–‡ä»¶ |
| `fs:copyFile` | Râ†’M | `src, dest` | å¤åˆ¶æ–‡ä»¶ |
| `fs:copyDir` | Râ†’M | `src, dest` | é€’å½’å¤åˆ¶ç›®å½• |
| `fs:moveFile` | Râ†’M | `src, dest` | ç§»åŠ¨æ–‡ä»¶ |
| `store:getTheme` | Râ†’M | - | è·å–ä¸»é¢˜ |
| `store:setTheme` | Râ†’M | `theme` | ä¿å­˜ä¸»é¢˜ |

---

## ä¸ƒã€éªŒæ”¶æ ‡å‡†ï¼ˆä¿®è®¢ç‰ˆï¼‰

### åŠŸèƒ½éªŒæ”¶

- [ ] å³é”®èœå•åœ¨æ–‡ä»¶/æ–‡ä»¶å¤¹ä¸Šæ­£ç¡®æ˜¾ç¤º
- [ ] æ–‡ä»¶å³é”®èœå•åŒ…å«"å¯¼å‡º HTML"å’Œ"å¯¼å‡º PDF"
- [ ] æ–‡ä»¶å¤¹å³é”®èœå•ä¸æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹
- [ ] å³é”®å¯¼å‡ºæœªæ‰“å¼€çš„æ–‡ä»¶æ­£å¸¸å·¥ä½œ
- [ ] èœå•é¡¹æ–‡æ¡ˆè·¨å¹³å°æ­£ç¡®ï¼ˆFinder/èµ„æºç®¡ç†å™¨/æ–‡ä»¶ç®¡ç†å™¨ï¼‰
- [ ] å¤åˆ¶è·¯å¾„/ç›¸å¯¹è·¯å¾„æ­£ç¡®
- [ ] åº”ç”¨å†…å¤åˆ¶/å‰ªåˆ‡/ç²˜è´´æ­£å¸¸
- [ ] å‰ªåˆ‡é¡¹æ˜¾ç¤ºåŠé€æ˜
- [ ] é‡å‘½åå†…è”ç¼–è¾‘æ­£å¸¸
- [ ] åˆ é™¤ç§»åˆ°å›æ”¶ç«™
- [ ] æ‰€æœ‰å¿«æ·é”®æ­£å¸¸
- [ ] åˆ·æ–°æŒ‰é’®æ­£ç¡®åˆ·æ–°æ–‡ä»¶æ ‘
- [ ] å¤§æ–‡ä»¶è™šæ‹Ÿæ»šåŠ¨æµç•…
- [ ] ä¸»é¢˜åˆ‡æ¢æ­£å¸¸

### å®‰å…¨éªŒæ”¶

- [ ] è·¯å¾„ç©¿è¶Šæ”»å‡»è¢«é˜»æ­¢
- [ ] å—ä¿æŠ¤è·¯å¾„æ“ä½œè¢«æ‹’ç»
- [ ] æ²™ç®±æ¨¡å¼æ­£å¸¸å·¥ä½œ

### è´¨é‡éªŒæ”¶

- [ ] æµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] TypeScript æ— ç±»å‹é”™è¯¯
- [ ] ESLint æ— è­¦å‘Š
- [ ] 125+ ç°æœ‰æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] æ–°å¢ 70+ æµ‹è¯•ç”¨ä¾‹

### æ€§èƒ½éªŒæ”¶

- [ ] å³é”®èœå•å¼¹å‡º < 50ms
- [ ] 5000 è¡Œæ–‡ä»¶é¦–æ¬¡æ¸²æŸ“ < 1s
- [ ] 10000 è¡Œæ–‡ä»¶é¦–æ¬¡æ¸²æŸ“ < 2s
- [ ] æ»šåŠ¨ FPS > 30

---

## å…«ã€å¼€å‘é¡ºåº

```
é˜¶æ®µ 0ï¼ˆå®‰å…¨åŠ å›ºï¼‰â† å¼€å‘å‰å¿…é¡»å®Œæˆ
    â†“
é˜¶æ®µ 1ï¼ˆå³é”®èœå• - Electron Menuï¼‰
    â†“
é˜¶æ®µ 2ï¼ˆåº”ç”¨å†…å‰ªè´´æ¿ - Zustandï¼‰
    â†“
é˜¶æ®µ 3ï¼ˆæµ‹è¯•è¦†ç›–ç‡ 80%ï¼‰
    â†“
é˜¶æ®µ 4ï¼ˆè™šæ‹Ÿæ»šåŠ¨ - react-virtuosoï¼‰
    â†“
é˜¶æ®µ 5ï¼ˆä¸»é¢˜åˆ‡æ¢ UIï¼‰
    â†“
v1.2 å‘å¸ƒ
```

---

## ä¹ã€v1.3 å»¶æœŸåŠŸèƒ½

| åŠŸèƒ½ | è¯´æ˜ | å»¶æœŸåŸå›  |
|------|------|----------|
| è·¨åº”ç”¨å‰ªè´´æ¿ | å¤åˆ¶æ–‡ä»¶åˆ° Finder | å¹³å°ç‰¹å®šæ ¼å¼å¤æ‚ |
| å¤šæ–‡ä»¶é€‰æ‹© | Shift/Cmd å¤šé€‰ | å¢åŠ å¤æ‚åº¦ |
| æ‹–æ‹½æ’åº | æ–‡ä»¶æ ‘æ‹–æ‹½ | éæ ¸å¿ƒåŠŸèƒ½ |

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0ï¼ˆä¿®è®¢ç‰ˆï¼‰
**åˆ›å»ºæ—¥æœŸ**ï¼š2026-01-03
**ä¿®è®¢æ—¥æœŸ**ï¼š2026-01-03
**çŠ¶æ€**ï¼šâœ… å®¡æ‰¹é€šè¿‡
**å®¡æ‰¹è®°å½•**ï¼š
- æ¶æ„å¸ˆï¼šæœ‰æ¡ä»¶é€šè¿‡
- å‰ç«¯ä¸“å®¶ï¼šéœ€ä¿®æ”¹ â†’ å·²é‡‡çº³å»ºè®®
- å®‰å…¨å®¡è®¡å¸ˆï¼šæœ‰æ¡ä»¶é€šè¿‡ â†’ å®‰å…¨é—®é¢˜å·²çº³å…¥é˜¶æ®µ0
- æµ‹è¯•ä¸“å®¶ï¼šä¸åŠæ ¼ â†’ è¦†ç›–ç‡ç›®æ ‡å·²æå‡åˆ°80%
